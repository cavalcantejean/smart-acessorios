rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Coleção de Usuários (usuarios) - TESTE ULTRA-SIMPLIFICADO
    match /usuarios/{userId} {
      // PERMITE QUALQUER CRIAÇÃO - APENAS PARA TESTE, INSEGURO PARA PRODUÇÃO
      allow create: if true;

      // Outras operações podem ser mantidas ou comentadas para o teste,
      // mas o foco é garantir que 'create' funcione.
      allow read, update, delete: if request.auth != null && request.auth.uid == userId;
      allow get: if true; // Permite leitura pública de perfis para teste
    }

    // Para isolar o problema, você pode comentar temporariamente as regras de outras coleções
    // se o erro persistir.
    /*
    // Função helper para verificar se o usuário é admin
    function isAdmin() {
      return request.auth != null && get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.isAdmin == true;
    }

    // Coleção de Acessórios (acessorios)
    match /acessorios/{accessoryId} {
      allow get, list: if true;
      allow create, delete, write: if isAdmin();
      allow update: if request.auth != null || isAdmin();
    }

    // Coleção de Posts do Blog (posts)
    match /posts/{postId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    // Coleção de Cupons (cupons)
    match /cupons/{couponId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    // Configurações do Site
    match /siteConfig/{configId} {
        allow get: if true;
        allow write: if isAdmin();
    }

    // Coleção de Testimonials (depoimentos)
    match /testimonials/{testimonialId} {
        allow get, list: if true;
        allow create, update, delete: if isAdmin();
    }
    */
  }
}
